# 基于UDP，模拟TCP的可靠传输  



## 待解决问题：  

1. 研究为什么UDP是不可靠的，TCP是可靠的？  
2. 设计传输的报文格式  
3. 详细拆分传输步骤  





### 问题一：为什么UDP是不可靠的，TCP是可靠的？  

UDP协议只是在IP协议上包装了下列信息：源端口、目标端口、长度、校验；而IP协议的主要任务，就是按照源IP地址向目标IP地址发送数据报。它并不管这个发送任务能否成功，它将这个发送的结果抛给上层传输层处理了。

UDP协议：

- 不保证消息交付：不确认，不重传，无超时
- 不保证交付顺序：不设置包序号，不重排，不会发生队首阻塞
- 不跟踪连接状态： 不必建立连接或重启状态机
- 不需要拥塞控制： 不内置客户端或网络反馈机制



希望解决UDP协议的这些“不可靠因素”，让我们来参照TCP协议是怎么处理这些因素的。



***TCP协议设置了确认号与序列号***；基于确认号和序列号，可以进行如下操作：

- 序列号机制  
根据序列号，可以有效的判断报文的实际应在所在的顺序，避免了传输过程的混乱引起的接受数据的乱序

- 超时重传机制    
发送方发送的报文中含有序列号，每当发送一个报文后，就启动一个计时器（RTO），该计时器的时间一般是有当前网络来决定的，一个RTT指的是当一个报文从发送到接收到对应的ACK标志的时间，RTO的决定一般是发送方尝试发送几个报文，然后取平均RTT时间来决定计时器的值。 当发送一个报文以后，发送方在计时范围以内，如果没有接收到相应的ACK确认报文，那么发送方就会重传该报文。

- 快速重传机制
该机制指的是，发送方一直发送报文，不会每发一次报文就都要等待到这个报文的ACK标志才发送下个报文。 当接收方发送接受的序列号不对的时候，发送连续的3个ACK标志，告诉发送方，这个报文在传输过程中出现了丢包。发送方如果接收到某个相同序列号的三个ACK报文，那么此时立马重发该报文，不用等待计时器的时间结束。  

- 滑动窗口机制  
滑动窗口机制有效的实现了“流量控制”的功能。“让发送方不要传输的太快，保证接收方有充足的时间接收”。  



### 问题二：如何设计数据传输协议的报文，才能让实现“有效传输”？  
参考TCP协议的报文结构。  
源端口和目的端口暂且抛弃；在模拟程序中，源端口和目的端口在Sender和Receiver初始化的时候就已经设定好了，没有必要在报文中反复体现。  
为了实现“序列号机制”带来的可靠传输便利，seq、ack（序列号、确认号）字段保留，均为32位。  
数据偏移字段（8位）————指出报文段的数据起始位置距离报文段的起始位置有多远（实际上记录了报文的首部长度），便于receiver接收报文后切割报文首部和报文所携带的数据。  
保留（5位）————致敬TCP，23333（其实并没有什么卵用，看上去让报文的结构更好看一点）。
SYN————1位。同步标志位，用于发起“建立连接”的请求。
ACK————1位。答复消息的发送方，“我已经收到消息”。
FIN————1位。传输结束之后，确认释放连接的标志。  
校验和————16位。用于检测数据的正确性。在配套程序中没有体现。
选项————长度可变，但是不会超过32位。可能携带的信息：最大报文长度（MSS）等。如果选项长度没有达到32位，那么在选项后面增加一部分的填充，使得选项的长度达到32位（整齐、好看2333）  
![报文设计图](https://s2.ax1x.com/2019/05/18/EOslaq.png)    







### 问题三：具体的传输流程  
![文件传输流程](https://s2.ax1x.com/2019/05/18/EOs8iV.png)  



#### 相关技术实现：

- DataGrameSocket
- DataGramePacket
- Thread  



#### 发送端视角  

1. 三次握手建立连接
2. 同时开三个线程：
   - 发送Segment
   - 接收Segment（ACK）
   - 重新发送Segment
3. 四次握手释放连接  



**文件的处理**：将文件以字节的形式读入到一个数组之中，在发送的时候分批将这个数组的内容一部分一部分的装进Segment发送给receiver。  

**滑动窗口的实现**：用三个指针分别记录“窗口的开头”，“在目前这个窗口中，下一个要发送的是哪一个”，“窗口的结尾”。在线程中对这些指针进行操作，从而模拟“滑动窗口”的实现。  

**Log的生成**：在线程中进行。每进行一个操作就在相关日志文件中记录一行Log。   



#### 接收端视角  

1. 三次握手建立连接  
2. 同时开三个线程：  
   - 接收Segment 
   - 返回ACK  
   - ……  
3. 四次握手释放连接






















### 引用  

 [《TCP为什么安全可靠》](https://blog.csdn.net/Awille/article/details/79748193)  

 [《UDP协议为什么“不可靠”》](https://www.jianshu.com/p/d5fbab829e37)  
